---
layout:     post
title:      阿里云CTF
subtitle:   2024
date:       2024-03-27
author:     lyk
header-img: img/post-bg-rwd.jpg
catalog: true
tags:
    - Writeup
---

### 0x01 web签到

命令参数注入

dig 命令读文件

https://gtfobins.github.io/gtfobins/dig/

```JSON
{"domain":"www.aliyunctf.com","type":"-f/flag"}
```



### 0x02 easyCAS

#### 非预期

看了下版本 5.3.16，log4j2 版本较低受 log4shell 影响，题目又说开了 debug

直接测试登录框用户名触发 payload

JNDI-Injection-Exploit 一把梭，打 SpringBoot 那个链反弹 shell

flag 在根目录 /flag.txt

#### 官方解

首先根据 题目描述 知道账号密码是 `apereo` 默认的。

去 `github` 下载源码：

![image-20240329201509412](/img/image-20240329201509412.png)

`5.3.16` ：https://github.com/apereo/cas-overlay-template/tree/5.3

拿下来后，`maven` 下载依赖，打开 `application.properties` :

```
overlays\org.apereo.cas.cas-server-webapp-tomcat-5.3.16\WEB-INF\classes\application.properties
```

得到默认

账号：`casuser`

密码：`Mellon`

```
cas.authn.accept.users=casuser::Mellon
```

登陆前点击 `Dashboard`

![image-20240329201800100](/img/image-20240329201800100.png)

点击以后会跳转到：

```
http://127.0.0.1:8080//login?service=http%3A%2F%2F题目地址%3A服题目端口%2Fstatus%2Fdashboard
```

然后把 `127.0.0.1:8080` 改成目标的 ip 和端口

再次访问会出来如下框框：

![image-20240329201835283](/img/image-20240329201835283.png)

然后登陆：

![image-20240329201913320](/img/image-20240329201913320.png)

跳转到此处，此时 `PATH` 为：`/status/dashboard` ，修改访问： `/status/heapdump`下载内存。

打开 `MAT` :https://www.eclipse.org/mat/downloads.php

分析内存，这就要考到题目第一个难点，需要知道 `apereo` 这款 `CAS` 对登陆参数 `execution`的加密细节：

首先定位到类： `org.apereo.cas.web.flow.actions.CasDefaultFlowUrlHandler`

![image-20240329202026122](/img/image-20240329202026122.png)

此处是获取 `exeuction` 的值，在此处下断点即可。

断下后看调用栈找到：

`org.springframework.webflow.mvc.servlet.FlowHandlerAdapter`的`handle`：

![image-20240329202049545](/img/image-20240329202049545.png)

获取 `execution` 以后跟进箭头指向的函数：

![image-20240329202125040](/img/image-20240329202125040.png)

该函数在：`org.springframework.webflow.executor.FlowExecutorImpl`

![image-20240329202236141](/img/image-20240329202236141.png)

跟如 `getFlowExecution` 函数：

![image-20240329202320127](/img/image-20240329202320127.png)

接着跟入：`decode`函数：

[![img](https://xzfile.aliyuncs.com/media/upload/picture/20240326184801-514c99d4-eb5e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240326184801-514c99d4-eb5e-1.png)

跟如 `decrypt` 函数，在 `org.apereo.cas.util.cipher.BaseBinaryCipherExecutor`:

[![img](https://xzfile.aliyuncs.com/media/upload/picture/20240326184825-5f4481b4-eb5e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240326184825-5f4481b4-eb5e-1.png)

在这个函数就是解密的最后一段，看看这个类的初始化函数：

[![img](https://xzfile.aliyuncs.com/media/upload/picture/20240326184849-6d6bebe2-eb5e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240326184849-6d6bebe2-eb5e-1.png)

这两个 `key` 是比较关键的，现在我们知道了类在：

`org.apereo.cas.util.cipher.BaseBinaryCipherExecutor` 直接去下载好的 `heapdump`搜索即可，用 `MAT` 的 `OQL` 查询（WebConflowConversationStateCipherExecutor 是 BaseBinary 的子类）：

```
select * from org.apereo.cas.util.cipher.WebConflowConversationStateCipherExecutor
```

保存 `encryptionSecretKey` 和 `signingKey` ：

[![img](https://xzfile.aliyuncs.com/media/upload/picture/20240326184912-7b2e4568-eb5e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240326184912-7b2e4568-eb5e-1.png)

[![img](https://xzfile.aliyuncs.com/media/upload/picture/20240326184932-8765a7f4-eb5e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240326184932-8765a7f4-eb5e-1.png)

用 `idea` 打开 `exp` 中的项目，修改 `src/test/java/exp5316.java` 里面的两个文件的绝对路径，运行都得到一段 `base64`，复制以后抓一下登陆包，修改一下 `execution` 参数 `uuid` 后面的即可：

[![img](https://xzfile.aliyuncs.com/media/upload/picture/20240326184956-959ddf4e-eb5e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240326184956-959ddf4e-eb5e-1.png)

然后再`post`中加入一个 `cmd` 参数：

[![img](https://xzfile.aliyuncs.com/media/upload/picture/20240326185015-a0c103ec-eb5e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240326185015-a0c103ec-eb5e-1.png)

执行成功，获取 `flag` ：

[![img](https://xzfile.aliyuncs.com/media/upload/picture/20240326185035-accfc088-eb5e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20240326185035-accfc088-eb5e-1.png)
